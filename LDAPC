#!/bin/bash

yum install git -y
cd /tmp
git clone https://github.com/nic-instruction/hello-nti-310.git

yum install -y openldap-servers openldap-clients

cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
chown ldap. /var/lib/ldap/DB_CONFIG

systemctl enable slapd
systemctl start slapd

yum install httpd -y
yum install epel-release -y
yum install phpldapadmin -y

#Let's SELinux know what is going on
setsebool -P httpd_can_connect_ldap on

systemctl enable httpd
systemctl start httpd

sed -i 's,Require local,#Require local\n   Require all granted,g' /etc/httpd/conf.d/phpldapadmin.conf

cp /tmp/hello-nti-310/config/config.php /etc/phpldapadmin/config.php
chown ldap:apache /etc/phpldapadmin/config.php

systemctl restart httpd.service

echo "phpldapadmin is now up and running"
echo "we are configuring ldap and ldapadmin"

#Generates and stores new passwd securely
newsecret=$(slappasswd -g)
newhash=$(slappasswd -s "$newsecret")
echo -n "$newsecret" > /root/ldap_admin_pass
chmod 0600 /root/ldap_admin_pass

echo -e "dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=nti310,dc=local
\n
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=ldapadm,dc=nti310,dc=local
\n
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: $newhash" > db.ldif

ldapmodify -Y EXTERNAL  -H ldapi:/// -f db.ldif

# Auth restriction

echo 'dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth" read by dn.base="cn=ldapadm,dc=nti310,dc=local" read by * none' > monitor.ldif

ldapmodify -Y EXTERNAL  -H ldapi:/// -f monitor.ldif

#Generates Certs

openssl req -new -x509 -nodes -out /etc/openldap/certs/nti310ldapcert.pem -keyout /etc/openldap/certs/nti310ldapkey.pem -days 365 -subj "/C=US/ST=WA/L=Seattle/O=SCC/OU=IT/CN=nti310.local"

chown -R ldap. /etc/openldap/certs/nti*.pem

echo -e "dn: cn=config
changetype: modify
replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/nti310ldapcert.pem
\n
dn: cn=config
changetype: modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/nti310ldapkey.pem" > certs.ldif

ldapmodify -Y EXTERNAL  -H ldapi:/// -f certs.ldif

# Test to see if cert config works
slaptest -u
echo "it works"

unalias cp

ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif

# Creates group and people structure base

echo -e "dn: dc=nti310,dc=local
dc: nti310
objectClass: top
objectClass: domain
\n
dn: cn=ldapadm ,dc=nti310,dc=local
objectClass: organizationalRole
cn: ldapadm
description: LDAP Manager
\n
dn: ou=People,dc=nti310,dc=local
objectClass: organizationalUnit
ou: People
\n
dn: ou=Group,dc=nti310,dc=local
objectClass: organizationalUnit
ou: Group" > base.ldif

setenforce 0

ldapadd -x -W -D "cn=ldapadm,dc=nti310,dc=local" -f base.ldif -y /root/ldap_admin_pass

#systemctl restart httpd


#LDIF Export for cn=Koda Mondragon,ou=People,dc=nti310,dc=local
# Server: NTI-310 Example LDAP Server (127.0.0.1)
# Search Scope: base
# Search Filter: (objectClass=*)
# Total Entries: 1
#
# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on January 25, 2019 2:16 am
# Version: 1.2.3

echo -e "version: 1
dn: cn=Person1,ou=People,dc=nti310,dc=local
cn: Person1
gidnumber: 500
givenname: Person1
homedirectory: /home/Person1
loginshell: /bin/sh
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: Person1
uid: Person1
uidnumber: 1001
userpassword: {SHA}R5nV3A38+e62G8u5F7tcdLoyZtg=
\n
dn: cn=Person2,ou=People,dc=nti310,dc=local
cn: Person2
gidnumber: 500
givenname: Person2
homedirectory: /home/Person2
loginshell: /bin/sh
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: Person2
uid: Person2
uidnumber: 1002
userpassword: {SHA}R5nV3A38+e62G8u5F7tcdLoyZtg=
\n
dn: cn=Person3,ou=People,dc=nti310,dc=local
cn: Person3
gidnumber: 500
givenname: Person3
homedirectory: /home/Person3
loginshell: /bin/sh
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: Person3
uid: Person3
uidnumber: 1003
userpassword: {SHA}R5nV3A38+e62G8u5F7tcdLoyZtg=
\n
dn: cn=Person4,ou=People,dc=nti310,dc=local
cn: Person4
gidnumber: 500
givenname: Person4
homedirectory: /home/Person4
loginshell: /bin/sh
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: Person4
uid: Person4
uidnumber: 1004
userpassword: {SHA}R5nV3A38+e62G8u5F7tcdLoyZtg=
\n
dn: cn=Person5,ou=People,dc=nti310,dc=local
cn: Person5
gidnumber: 500
givenname: Person5
homedirectory: /home/Person5
loginshell: /bin/sh
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: Person5
uid: Person5
uidnumber: 1005
userpassword: {SHA}R5nV3A38+e62G8u5F7tcdLoyZtg=
\n
dn: cn=HoangD,ou=People,dc=nti310,dc=local
cn: HoangD
gidnumber: 500
givenname: HoangD
homedirectory: /home/HoangD
loginshell: /bin/sh
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: HoangD
uid: HoangD
uidnumber: 1006
userpassword: {SHA}R5nV3A38+e62G8u5F7tcdLoyZtg=" > /tmp/users.ldif

ldapadd -x -W -D "cn=ldapadm,dc=nti310,dc=local" -f /tmp/users.ldif -y /root/ldap_admin_pass

# LDIF Export for ou=Group,dc=nti310,dc=local
# Server: NTI-310 Example LDAP Server (127.0.0.1)
# Search Scope: base
# Search Filter: (objectClass=*)
# Total Entries: 1
#
# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on January 25, 2019 3:53 am
# Version: 1.2.3

version: 1
# Entry 1: ou=Group,dc=nti310,dc=local
dn: ou=Group2,dc=nti310,dc=local
objectclass: organizationalUnit
ou: Group2
version: 1
# Entry 1: ou=Group,dc=nti310,dc=local
dn: ou=Group3,dc=nti310,dc=local
objectclass: organizationalUnit
ou: Group3

ldapadd -x -W -D "cn=ldapadm,dc=nti310,dc=local" -f /tmp/groups.ldif -y /root/ldap_admin_pass

#for servername in $(gcloud compute instances list | awk '{print $1}' | sed "1 d" | grep -v nagios4419 );  do gcloud compute ssh --zone us-east1-b koda@$servername --command='sudo yum -y install wget && sudo wget https://raw.githubusercontent.com/dakoda17/NTI-310/master/hello-nti-310/config/nagiosclient421 && sudo bash nagiosclient421'; done

#this line restarts the system
systemctl restart httpd



#Client automation
sudo yum -y update && yum -y install rsyslog
sudo systemctl start rsyslog
sudo systemctl enable rsyslog



#sending the logs to rsyslog
echo "*.* @@rsyslog:514" >> /etc/rsyslog.conf
systemctl restart rsyslog
systemctl status rsyslog

